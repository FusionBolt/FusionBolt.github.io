<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Homura">
    
    <title>
        
            Rc-lang开发周记15 Rust源码学习之desugar |
        
        Homura&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"fusionbolt.github.io","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.jpeg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"我们所度过的每个平凡的日常\n也许就是连续发生的奇迹\n"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.2"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
    <meta name="description" content="pixiv:68232005   这周可以说几乎没写什么代码，都在学习别人的实现。在参考别人的做法之前自己写一版比较合适，这样会对整体有个了解（这样有利于阅读代码），知道哪些地方会有问题，看别人的代码后会发现哪里不一样并且去思考差异。不过我之前已经写过简易的实现了，因此直接来参考Rust的实现了 本周看的内容一半是desugar，另一半是关于MIR的。讲解的话目前先讲一下desugar的内容，内">
<meta property="og:type" content="article">
<meta property="og:title" content="Rc-lang开发周记15 Rust源码学习之desugar">
<meta property="og:url" content="https://fusionbolt.github.io/2022/04/17/rc-lang-dev/rc-lang-dev-15/index.html">
<meta property="og:site_name" content="Homura&#39;s Blog">
<meta property="og:description" content="pixiv:68232005   这周可以说几乎没写什么代码，都在学习别人的实现。在参考别人的做法之前自己写一版比较合适，这样会对整体有个了解（这样有利于阅读代码），知道哪些地方会有问题，看别人的代码后会发现哪里不一样并且去思考差异。不过我之前已经写过简易的实现了，因此直接来参考Rust的实现了 本周看的内容一半是desugar，另一半是关于MIR的。讲解的话目前先讲一下desugar的内容，内">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fusionbolt.github.io/images/rc-lang-dev-15/68232005_p0.png">
<meta property="article:published_time" content="2022-04-17T06:23:11.000Z">
<meta property="article:modified_time" content="2022-06-19T07:13:12.358Z">
<meta property="article:author" content="Homura">
<meta property="article:tag" content="Rc-lang">
<meta property="article:tag" content="Rust">
<meta property="article:tag" content="Desugar">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fusionbolt.github.io/images/rc-lang-dev-15/68232005_p0.png">

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0X2R555BND"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0X2R555BND');
</script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Homura's Blog" type="application/atom+xml">
</head>
<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Homura&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/navigation"
                            >
                                导航
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/navigation">导航</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Rc-lang开发周记15 Rust源码学习之desugar</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpeg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Homura</span>
                        
                            <span class="author-label">我摸到了！</span>
                        
                    </div>
                    <div class="meta-info">
                        .article-meta-info {
  font-size: 0.8rem;
  color: var(--third-text-color);

  .article-meta-item {
    margin-right: 10px;

    &:last-child {
      margin-right: 0;
    }
  }


  .article-tags, .article-categories {
    display: inline;

    ul, li {
      display: inline;
    }

    a {
      color: var(--third-text-color);

      &:hover {
        color: var(--primary-color);
      }
    }
  }


  .article-wordcount, .article-tags {
    +keep-mobile() {
      display: none;
    }
  }

  .article-min2read, .article-categories {

    +keep-tablet() {
      display: none;
    }

  }
}

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rc-lang-dev-15/68232005_p0.png"
                      alt="68232005_p0.png"
                ></p>
<center style="font-size:14px;color:#C0C0C0;text-decoration:underline">pixiv:68232005</center> 

<p>这周可以说几乎没写什么代码，都在学习别人的实现。在参考别人的做法之前自己写一版比较合适，这样会对整体有个了解（这样有利于阅读代码），知道哪些地方会有问题，看别人的代码后会发现哪里不一样并且去思考差异。不过我之前已经写过简易的实现了，因此直接来参考Rust的实现了</p>
<p>本周看的内容一半是desugar，另一半是关于MIR的。讲解的话目前先讲一下desugar的内容，内容相对较少能够一篇讲完。MIR的东西非常多，笔记也没有整理好，之后会单独开启一个源码阅读系列的坑</p>
<p>在讲之前首先要提的是<strong>为什么要学习他人的实现</strong>。尽管写出来能跑是没有问题的，但是参考这样的项目的过程中能学到他人写代码的方式，学到更多不一样的实现方式</p>
<h1 id="desugar"><a href="#desugar" class="headerlink" title="desugar"></a>desugar</h1><h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>我们现在在使用的编程语言中有一些语法糖，这些语法糖本质上是对一些功能的包装，让我们用的更方便，但是没有做到一些什么没有这个语法糖所做不到的东西。</p>
<p>这里举一个很直观的例子，ruby中有一个关键字是unless，它的功能是如果false则执行第一个分支，否则执行第二个分支，相当于if !cond</p>
<h2 id="为什么需要"><a href="#为什么需要" class="headerlink" title="为什么需要"></a>为什么需要</h2><p>上面也提到了只是包装，那么可能多种不同形式的语法糖都是针对同一种功能，像C语言中的while和for本质都是一个loop（Rust的for并不是，后面会提到这种for的desugar过程）</p>
<p>desugar的过程是将这些都转换为了更本质的东西，我觉得这属于一种“去重”的过程。还是上面的例子，假设需要对loop做优化，没有desugar的情况下我们需要对while和for两者都进行处理，两者又有轻微的差别，导致实现起来更不方便，每个优化都需要对这些细节做处理，那不如直接全部转换成一种形式来处理处理</p>
<p>关于Rust的文档中的介绍是这样</p>
<blockquote>
<p>This means many structures are removed if they are irrelevant for type analysis or similar syntax agnostic analyses.</p>
</blockquote>
<h1 id="Rust的实现"><a href="#Rust的实现" class="headerlink" title="Rust的实现"></a>Rust的实现</h1><p>官方的文档介绍</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://rustc-dev-guide.rust-lang.org/lowering.html" >https://rustc-dev-guide.rust-lang.org/lowering.html<i class="fas fa-external-link-alt"></i></a></p>
<p>在这里我要给Rust一个好评，开发文档比较详细，而且一些注释也相对容易懂一些。后面的很多东西都会以注释为参考讲了大概做了什么，注意这里<strong>我们的目的并不是搞清楚细节，而是搞清楚都做了什么操作，所以细节部分点到为止</strong>，细节深究下去是无底洞，有兴趣可以去源码处深入看一下</p>
<p>desugar相关代码不特别说明根目录都是rustc_ast_lowering</p>
<h2 id="读代码之前需要了解的"><a href="#读代码之前需要了解的" class="headerlink" title="读代码之前需要了解的"></a>读代码之前需要了解的</h2><p>了解了这些能够更容易看明白代码</p>
<ol>
<li>各种参数更多是使用ir来标识以及获取的</li>
<li>span用于记录源码相关信息</li>
<li>arean.alloc是用于分配构建ir的，看实现的时候不需要在意这里的细节，只需要看传进去的IR</li>
</ol>
<h2 id="DesugaringKind"><a href="#DesugaringKind" class="headerlink" title="DesugaringKind"></a>DesugaringKind</h2><p>这个类型在rustc_span/src/hygine.rs中</p>
<p>实际使用的时候主要用于创建span的时候填入相关信息，因此并没有放到ast_lowering的位置</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">DesugaringKind</span></span> &#123;</span><br><span class="line">    <span class="comment">/// We desugar `if c &#123; i &#125; else &#123; e &#125;` to `match $ExprKind::Use(c) &#123; true =&gt; i, _ =&gt; e &#125;`.</span></span><br><span class="line">    <span class="comment">/// However, we do not want to blame `c` for unreachability but rather say that `i`</span></span><br><span class="line">    <span class="comment">/// is unreachable. This desugaring kind allows us to avoid blaming `c`.</span></span><br><span class="line">    <span class="comment">/// This also applies to `while` loops.</span></span><br><span class="line">    CondTemporary,</span><br><span class="line">    QuestionMark,</span><br><span class="line">    TryBlock,</span><br><span class="line">    <span class="comment">/// Desugaring of an `impl Trait` in return type position</span></span><br><span class="line">    <span class="comment">/// to an `type Foo = impl Trait;` and replacing the</span></span><br><span class="line">    <span class="comment">/// `impl Trait` with `Foo`.</span></span><br><span class="line">    OpaqueTy,</span><br><span class="line">    Async,</span><br><span class="line">    Await,</span><br><span class="line">    ForLoop,</span><br><span class="line">    LetElse,</span><br><span class="line">    WhileLoop,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先不考虑Async和Await，我们来一个个说其他的</p>
<h2 id="CondTemporary"><a href="#CondTemporary" class="headerlink" title="CondTemporary"></a>CondTemporary</h2><p>这部分都在src/expr.rs中</p>
<p>我们先来看一下它的调用位置，发现是在manage_let_cond这个函数中</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If `cond` kind is `let`, returns `let`. Otherwise, wraps and returns `cond`</span></span><br><span class="line"><span class="comment">// in a temporary block.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">manage_let_cond</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, cond: &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt;) -&gt; &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">has_let_expr</span></span>&lt;<span class="symbol">&#x27;hir</span>&gt;(expr: &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt;) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> expr.kind &#123;</span><br><span class="line">            hir::ExprKind::Binary(_, lhs, rhs) =&gt; has_let_expr(lhs) || has_let_expr(rhs),</span><br><span class="line">            hir::ExprKind::Let(..) =&gt; <span class="literal">true</span>,</span><br><span class="line">            _ =&gt; <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> has_let_expr(cond) &#123;</span><br><span class="line">        cond</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> reason = DesugaringKind::CondTemporary;</span><br><span class="line">        <span class="keyword">let</span> span_block = <span class="keyword">self</span>.mark_span_with_reason(reason, cond.span, <span class="literal">None</span>);</span><br><span class="line">        <span class="keyword">self</span>.expr_drop_temps(span_block, cond, AttrVec::new())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转换条件"><a href="#转换条件" class="headerlink" title="转换条件"></a>转换条件</h3><p>根据函数名和参数我们可以得知这个是处理cond不为let的情况下，既然是cond那么应当会出现在while和if中</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>实际查看manage_let_cond的usage也正是如此。这两处的处理都是类似的，因此我选取一段来介绍</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lowered_cond = <span class="keyword">self</span>.lower_expr(cond);</span><br><span class="line"><span class="keyword">let</span> new_cond = <span class="keyword">self</span>.manage_let_cond(lowered_cond);</span><br></pre></td></tr></table></figure>

<p>可以看到十分简单，就是先对cond本身lower，然后再对整个cond lower</p>
<p>然后我们再回到manage_let_cond的实现中</p>
<p>根据实现可以看到对expr递归判断，如果包含let则直接返回原始cond，否则进行转换</p>
<p>span_block是用于记录信息的，关键在expr_drop_temps中</p>
<h3 id="本质行为"><a href="#本质行为" class="headerlink" title="本质行为"></a>本质行为</h3><p>进入实现可以看到</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Wrap the given `expr` in a terminating scope using `hir::ExprKind::DropTemps`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In terms of drop order, it has the same effect as wrapping `expr` in</span></span><br><span class="line"><span class="comment">/// `&#123; let _t = $expr; _t &#125;` but should provide better compile-time performance.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// The drop order can be important in e.g. `if expr &#123; .. &#125;`.</span></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">super</span>) <span class="function"><span class="keyword">fn</span> <span class="title">expr_drop_temps</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    span: Span,</span><br><span class="line">    expr: &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt;,</span><br><span class="line">    attrs: AttrVec,</span><br><span class="line">) -&gt; &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_drop_temps_mut(span, expr, attrs))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span>(<span class="keyword">super</span>) <span class="function"><span class="keyword">fn</span> <span class="title">expr_drop_temps_mut</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    span: Span,</span><br><span class="line">    expr: &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt;,</span><br><span class="line">    attrs: AttrVec,</span><br><span class="line">) -&gt; hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">self</span>.expr(span, hir::ExprKind::DropTemps(expr), attrs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际做的事情就是转换为了DropTemps这种类型的Expr</p>
<h2 id="QuestionMark"><a href="#QuestionMark" class="headerlink" title="QuestionMark"></a>QuestionMark</h2><h3 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h3><p>QuestionMark是Result为Err或者Option为None的时候直接抛出错误的一种语法糖，摘选一段官方的例子</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![allow(unused_variables)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line"><span class="keyword">use</span> std::num::ParseIntError;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">try_to_parse</span></span>() -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">i32</span>, ParseIntError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> x: <span class="built_in">i32</span> = <span class="string">&quot;123&quot;</span>.parse()?; <span class="comment">// x = 123</span></span><br><span class="line">    <span class="keyword">let</span> y: <span class="built_in">i32</span> = <span class="string">&quot;24a&quot;</span>.parse()?; <span class="comment">// returns an Err() immediately</span></span><br><span class="line">    <span class="literal">Ok</span>(x + y)                    <span class="comment">// Doesn&#x27;t run.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> res = try_to_parse();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, res);</span><br><span class="line"><span class="built_in">assert!</span>(res.is_err())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看QuestionMark的usage，找到了lower_expr_try这个函数</p>
<h3 id="做了什么"><a href="#做了什么" class="headerlink" title="做了什么"></a>做了什么</h3><p>先来看注释，这里的注释可以说是非常清楚了，将一个QuestionMark转换为了一个模式匹配</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Desugar `ExprKind::Try` from: `&lt;expr&gt;?` into:</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// match Try::branch(&lt;expr&gt;) &#123;</span></span><br><span class="line"><span class="comment">///     ControlFlow::Continue(val) =&gt; #[allow(unreachable_code)] val,,</span></span><br><span class="line"><span class="comment">///     ControlFlow::Break(residual) =&gt;</span></span><br><span class="line"><span class="comment">///         #[allow(unreachable_code)]</span></span><br><span class="line"><span class="comment">///         // If there is an enclosing `try &#123;...&#125;`:</span></span><br><span class="line"><span class="comment">///         break &#x27;catch_target Try::from_residual(residual),</span></span><br><span class="line"><span class="comment">///         // Otherwise:</span></span><br><span class="line"><span class="comment">///         return Try::from_residual(residual),</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br></pre></td></tr></table></figure>

<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>函数签名</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_expr_try</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, span: Span, sub_expr: &amp;Expr) -&gt; hir::ExprKind&lt;<span class="symbol">&#x27;hir</span>&gt;</span><br></pre></td></tr></table></figure>

<p>既然是返回了一个match，那么我们先看一下Expr::Match的结构</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A `match` block, with a source that indicates whether or not it is</span></span><br><span class="line"><span class="comment">/// the result of a desugaring, and if so, which kind.</span></span><br><span class="line">Match(&amp;<span class="symbol">&#x27;hir</span> Expr&lt;<span class="symbol">&#x27;hir</span>&gt;, &amp;<span class="symbol">&#x27;hir</span> [Arm&lt;<span class="symbol">&#x27;hir</span>&gt;], MatchSource)</span><br></pre></td></tr></table></figure>

<p>根据注释的内容看上去分为三个部分</p>
<ol>
<li>Try::branch(<expr>)</li>
</ol>
<p>非常直接的操作，直接lower传进来的sub_expr</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `Try::branch(&lt;expr&gt;)`</span></span><br><span class="line"><span class="keyword">let</span> scrutinee = &#123;</span><br><span class="line">    <span class="comment">// expand &lt;expr&gt;</span></span><br><span class="line">    <span class="keyword">let</span> sub_expr = <span class="keyword">self</span>.lower_expr_mut(sub_expr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.expr_call_lang_item_fn(</span><br><span class="line">        unstable_span,</span><br><span class="line">        hir::LangItem::TryTraitBranch,</span><br><span class="line">        arena_vec![<span class="keyword">self</span>; sub_expr],</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>ControlFlow::Continue(val)</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `ControlFlow::Break(residual) =&gt;</span></span><br><span class="line"><span class="comment">//     #[allow(unreachable_code)]</span></span><br><span class="line"><span class="comment">//     return Try::from_residual(residual),`</span></span><br><span class="line"><span class="keyword">let</span> break_arm = &#123;</span><br><span class="line">		... <span class="comment">// 省略</span></span><br><span class="line">    <span class="keyword">let</span> break_pat = <span class="keyword">self</span>.pat_cf_break(try_span, residual_local);</span><br><span class="line">    <span class="keyword">self</span>.arm(break_pat, ret_expr)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里的arm是构建了hir的Match的Arm参数</p>
<ol>
<li>ControlFlow::Break(residual)</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `ControlFlow::Break(residual) =&gt;</span></span><br><span class="line"><span class="comment">//     #[allow(unreachable_code)]</span></span><br><span class="line"><span class="comment">//     return Try::from_residual(residual),`</span></span><br><span class="line"><span class="keyword">let</span> break_arm = &#123;</span><br><span class="line">		... <span class="comment">// 省略</span></span><br><span class="line">    <span class="keyword">let</span> break_pat = <span class="keyword">self</span>.pat_cf_break(try_span, residual_local);</span><br><span class="line">    <span class="keyword">self</span>.arm(break_pat, ret_expr)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>和上面差不多，细节都在省略的部分</p>
<p>在实际的处理中在最前面的有一部分像上面的CondTemporary一样，先创建一个span用于记录源码相关的信息，源码不再赘述</p>
<p>还会创建一个*<code>#[allow(unreachable_code)]</code>* 供后面的match使用</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> attr = &#123;</span><br><span class="line">    <span class="comment">// `allow(unreachable_code)`</span></span><br><span class="line">    <span class="keyword">let</span> allow = &#123;</span><br><span class="line">        <span class="keyword">let</span> allow_ident = Ident::new(sym::allow, <span class="keyword">self</span>.lower_span(span));</span><br><span class="line">        <span class="keyword">let</span> uc_ident = Ident::new(sym::unreachable_code, <span class="keyword">self</span>.lower_span(span));</span><br><span class="line">        <span class="keyword">let</span> uc_nested = attr::mk_nested_word_item(uc_ident);</span><br><span class="line">        attr::mk_list_item(allow_ident, <span class="built_in">vec!</span>[uc_nested])</span><br><span class="line">    &#125;;</span><br><span class="line">    attr::mk_attr_outer(allow)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> attrs = <span class="built_in">vec!</span>[attr];</span><br></pre></td></tr></table></figure>

<h2 id="TryBlock"><a href="#TryBlock" class="headerlink" title="TryBlock"></a>TryBlock</h2><p>在lower_expr_try_block中被用到</p>
<h3 id="做了什么-1"><a href="#做了什么-1" class="headerlink" title="做了什么"></a>做了什么</h3><p>这里的注释解释的比较清楚了，我就不再赘述</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Desugar `try &#123; &lt;stmts&gt;; &lt;expr&gt; &#125;` into `&#123; &lt;stmts&gt;; ::std::ops::Try::from_output(&lt;expr&gt;) &#125;`,</span></span><br><span class="line"><span class="comment">/// `try &#123; &lt;stmts&gt;; &#125;` into `&#123; &lt;stmts&gt;; ::std::ops::Try::from_output(()) &#125;`</span></span><br><span class="line"><span class="comment">/// and save the block id to use it as a break target for desugaring of the `?` operator.</span></span><br></pre></td></tr></table></figure>

<p>最终都是转换为一个包含stmts和::std::ops::Try::from_output的block</p>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><p>我们从返回值往上看，可以看到返回了一个Block，Block的第二个参数是Label，这里并不需要因此设置为了None</p>
<p>那么我们顺着第一个参数block往上看来源，又回到了函数的开始</p>
<p>和注释所讲的一样，根据是否有一个expr来做两种不同的处理方式，也是比较直观的实现</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_expr_try_block</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, body: &amp;Block) -&gt; hir::ExprKind&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">self</span>.with_catch_scope(body.id, |this| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> block = this.lower_block_noalloc(body, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Final expression of the block (if present) or `()` with span at the end of block</span></span><br><span class="line">        <span class="keyword">let</span> (try_span, tail_expr) = <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(expr) = block.expr.take() &#123;</span><br><span class="line">            (</span><br><span class="line">                this.mark_span_with_reason(</span><br><span class="line">                    DesugaringKind::TryBlock,</span><br><span class="line">                    expr.span,</span><br><span class="line">                    this.allow_try_trait.clone(),</span><br><span class="line">                ),</span><br><span class="line">                expr,</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> try_span = this.mark_span_with_reason(</span><br><span class="line">                DesugaringKind::TryBlock,</span><br><span class="line">                this.sess.source_map().end_point(body.span),</span><br><span class="line">                this.allow_try_trait.clone(),</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            (try_span, this.expr_unit(try_span))</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> ok_wrapped_span =</span><br><span class="line">            this.mark_span_with_reason(DesugaringKind::TryBlock, tail_expr.span, <span class="literal">None</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// `::std::ops::Try::from_output($tail_expr)`</span></span><br><span class="line">        block.expr = <span class="literal">Some</span>(this.wrap_in_try_constructor(</span><br><span class="line">            hir::LangItem::TryTraitFromOutput,</span><br><span class="line">            try_span,</span><br><span class="line">            tail_expr,</span><br><span class="line">            ok_wrapped_span,</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        hir::ExprKind::Block(this.arena.alloc(block), <span class="literal">None</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OpaqueTy"><a href="#OpaqueTy" class="headerlink" title="OpaqueTy"></a>OpaqueTy</h2><h3 id="OpaqueTy是什么"><a href="#OpaqueTy是什么" class="headerlink" title="OpaqueTy是什么"></a>OpaqueTy是什么</h3><p>OpaqueTy是impl Trait的一种别名，看一下这个例子</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Foo</span></span> = <span class="keyword">impl</span> Bar;</span><br></pre></td></tr></table></figure>

<p>实际参数使用Foo的时候只能使用Bar中的接口，不论实现了Bar的类型是否实现了其他类型</p>
<h3 id="lower做了什么"><a href="#lower做了什么" class="headerlink" title="lower做了什么"></a>lower做了什么</h3><p>关于这个lower的操作，在DesugaringKind::OpaqueTy的位置写的非常清楚了，只是做了简单的类型替换</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Desugaring of an `impl Trait` in return type position</span></span><br><span class="line"><span class="comment">/// to an `type Foo = impl Trait;` and replacing the</span></span><br><span class="line"><span class="comment">/// `impl Trait` with `Foo`.</span></span><br></pre></td></tr></table></figure>

<h3 id="lower操作"><a href="#lower操作" class="headerlink" title="lower操作"></a>lower操作</h3><p>lower操作在lower_opaque_impl_trait这个函数中(src/lib.rs)</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_opaque_impl_trait</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        span: Span,</span><br><span class="line">        fn_def_id: <span class="built_in">Option</span>&lt;LocalDefId&gt;,</span><br><span class="line">        origin: hir::OpaqueTyOrigin,</span><br><span class="line">        opaque_ty_node_id: NodeId,</span><br><span class="line">        capturable_lifetimes: <span class="built_in">Option</span>&lt;&amp;FxHashSet&lt;hir::LifetimeName&gt;&gt;,</span><br><span class="line">        lower_bounds: <span class="keyword">impl</span> <span class="built_in">FnOnce</span>(&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>) -&gt; hir::GenericBounds&lt;<span class="symbol">&#x27;hir</span>&gt;,</span><br><span class="line">    ) -&gt; hir::TyKind&lt;<span class="symbol">&#x27;hir</span>&gt; </span><br></pre></td></tr></table></figure>

<p>来看一下返回值的部分，可以看到主要处理分为两部分，一部分是处理ID相关的，另一部分是处理lifetime</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `impl Trait` now just becomes `Foo&lt;&#x27;a, &#x27;b, ..&gt;`.</span></span><br><span class="line">    hir::TyKind::OpaqueDef(hir::ItemId &#123; def_id: opaque_ty_def_id &#125;, lifetimes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里也就不展开了，上面的细节很多是关于type相关的，这部分我不了解，内容也比较长。</p>
<p>lower_opaque_impl_trait这个函数则是被在上面的lower_ty_direct()调用</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">TyKind::ImplTrait(def_node_id, <span class="keyword">ref</span> bounds) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> span = t.span;</span><br><span class="line">  <span class="keyword">match</span> itctx &#123;</span><br><span class="line">      ImplTraitContext::ReturnPositionOpaqueTy &#123; fn_def_id, origin &#125; =&gt; <span class="keyword">self</span></span><br><span class="line">          .lower_opaque_impl_trait(</span><br><span class="line">              span,</span><br><span class="line">              <span class="literal">Some</span>(fn_def_id),</span><br><span class="line">              origin,</span><br><span class="line">              def_node_id,</span><br><span class="line">              <span class="literal">None</span>,</span><br><span class="line">              |this| this.lower_param_bounds(bounds, itctx),</span><br><span class="line">          ),</span><br><span class="line">      ImplTraitContext::TypeAliasesOpaqueTy &#123; <span class="keyword">ref</span> capturable_lifetimes &#125; =&gt; &#123;</span><br><span class="line">          <span class="comment">// Reset capturable lifetimes, any nested impl trait</span></span><br><span class="line">          <span class="comment">// types will inherit lifetimes from this opaque type,</span></span><br><span class="line">          <span class="comment">// so don&#x27;t need to capture them again.</span></span><br><span class="line">          <span class="keyword">let</span> nested_itctx = ImplTraitContext::TypeAliasesOpaqueTy &#123;</span><br><span class="line">              capturable_lifetimes: &amp;<span class="keyword">mut</span> FxHashSet::default(),</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">self</span>.lower_opaque_impl_trait(</span><br><span class="line">              span,</span><br><span class="line">              <span class="literal">None</span>,</span><br><span class="line">              hir::OpaqueTyOrigin::TyAlias,</span><br><span class="line">              def_node_id,</span><br><span class="line">              <span class="literal">Some</span>(capturable_lifetimes),</span><br><span class="line">              |this| this.lower_param_bounds(bounds, nested_itctx),</span><br><span class="line">          )</span><br><span class="line">      &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以看到这里的TypeKind为ImplTrait且ImplTraitContext为TypeAliasesOpaqueTy或者ReturnPositionOpaqueTy的时候才会做这个desugar操作</p>
<ul>
<li><input disabled="" type="checkbox"> 这里我其实不是很明白。。</li>
</ul>
<h3 id="ImpltraitContext"><a href="#ImpltraitContext" class="headerlink" title="ImpltraitContext"></a>ImpltraitContext</h3><p>来看一下ImpltraitContext，根据Disallowed注释大意和成员可以得知这个类主要关联了一个位置是否可以使用impl trait</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Context of `impl Trait` in code, which determines whether it is allowed in an HIR subtree,</span></span><br><span class="line"><span class="comment">/// and if so, what meaning it has.</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ImplTraitContext</span></span>&lt;<span class="symbol">&#x27;b</span>, <span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Treat `impl Trait` as shorthand for a new universal generic parameter.</span></span><br><span class="line">    <span class="comment">/// Example: `fn foo(x: impl Debug)`, where `impl Debug` is conceptually</span></span><br><span class="line">    <span class="comment">/// equivalent to a fresh universal parameter like `fn foo&lt;T: Debug&gt;(x: T)`.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Newly generated parameters should be inserted into the given `Vec`.</span></span><br><span class="line">    Universal(&amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> <span class="built_in">Vec</span>&lt;hir::GenericParam&lt;<span class="symbol">&#x27;a</span>&gt;&gt;, LocalDefId),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Treat `impl Trait` as shorthand for a new opaque type.</span></span><br><span class="line">    <span class="comment">/// Example: `fn foo() -&gt; impl Debug`, where `impl Debug` is conceptually</span></span><br><span class="line">    <span class="comment">/// equivalent to a new opaque type like `type T = impl Debug; fn foo() -&gt; T`.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    ReturnPositionOpaqueTy &#123;</span><br><span class="line">        <span class="comment">/// `DefId` for the parent function, used to look up necessary</span></span><br><span class="line">        <span class="comment">/// information later.</span></span><br><span class="line">        fn_def_id: LocalDefId,</span><br><span class="line">        <span class="comment">/// Origin: Either OpaqueTyOrigin::FnReturn or OpaqueTyOrigin::AsyncFn,</span></span><br><span class="line">        origin: hir::OpaqueTyOrigin,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/// Impl trait in type aliases.</span></span><br><span class="line">    TypeAliasesOpaqueTy &#123;</span><br><span class="line">        <span class="comment">/// Set of lifetimes that this opaque type can capture, if it uses</span></span><br><span class="line">        <span class="comment">/// them. This includes lifetimes bound since we entered this context.</span></span><br><span class="line">        <span class="comment">/// For example:</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// ```</span></span><br><span class="line">        <span class="comment">/// type A&lt;&#x27;b&gt; = impl for&lt;&#x27;a&gt; Trait&lt;&#x27;a, Out = impl Sized + &#x27;a&gt;;</span></span><br><span class="line">        <span class="comment">/// ```</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// Here the inner opaque type captures `&#x27;a` because it uses it. It doesn&#x27;t</span></span><br><span class="line">        <span class="comment">/// need to capture `&#x27;b` because it already inherits the lifetime</span></span><br><span class="line">        <span class="comment">/// parameter from `A`.</span></span><br><span class="line">        <span class="comment">// FIXME(impl_trait): but `required_region_bounds` will ICE later</span></span><br><span class="line">        <span class="comment">// anyway.</span></span><br><span class="line">        capturable_lifetimes: &amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> FxHashSet&lt;hir::LifetimeName&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/// `impl Trait` is not accepted in this position.</span></span><br><span class="line">    Disallowed(ImplTraitPosition),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在上面只有ReturnPositionOpaqueTy和TypeAliasesOpaqueTy的情况下可以使用，当然从名字就可以看出来这两种情况就是为了OpaqueTy而设计的</p>
<h2 id="ForLoop"><a href="#ForLoop" class="headerlink" title="ForLoop"></a>ForLoop</h2><p>调用处的函数签名</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_expr_for</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        e: &amp;Expr,</span><br><span class="line">        pat: &amp;Pat,</span><br><span class="line">        head: &amp;Expr,</span><br><span class="line">        body: &amp;Block,</span><br><span class="line">        opt_label: <span class="built_in">Option</span>&lt;Label&gt;,</span><br><span class="line">    ) -&gt; hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br></pre></td></tr></table></figure>

<p>注释写的非常详细了，将一个ForLoop转换为一个iterator操作</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Desugar `ExprForLoop` from: `[opt_ident]: for &lt;pat&gt; in &lt;head&gt; &lt;body&gt;` into:</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// &#123;</span></span><br><span class="line"><span class="comment">///     let result = match IntoIterator::into_iter(&lt;head&gt;) &#123;</span></span><br><span class="line"><span class="comment">///         mut iter =&gt; &#123;</span></span><br><span class="line"><span class="comment">///             [opt_ident]: loop &#123;</span></span><br><span class="line"><span class="comment">///                 match Iterator::next(&amp;mut iter) &#123;</span></span><br><span class="line"><span class="comment">///                     None =&gt; break,</span></span><br><span class="line"><span class="comment">///                     Some(&lt;pat&gt;) =&gt; &lt;body&gt;,</span></span><br><span class="line"><span class="comment">///                 &#125;;</span></span><br><span class="line"><span class="comment">///             &#125;</span></span><br><span class="line"><span class="comment">///         &#125;</span></span><br><span class="line"><span class="comment">///     &#125;;</span></span><br><span class="line"><span class="comment">///     result</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br></pre></td></tr></table></figure>

<p>实现比较长就不贴了，想要了解更详细的可以去源码处查看</p>
<h2 id="LetElse"><a href="#LetElse" class="headerlink" title="LetElse"></a>LetElse</h2><h3 id="什么情况会转换"><a href="#什么情况会转换" class="headerlink" title="什么情况会转换"></a>什么情况会转换</h3><p>在lower_let_else中被调用，而这个lower_let_else则是在lower_stmts中</p>
<p>这是lower_stmts中的处理代码，可以看到是InitElse的情况下会进行处理</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> expr = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> [s, tail @ ..] = ast_stmts &#123;</span><br><span class="line">            <span class="keyword">match</span> s.kind &#123;</span><br><span class="line">                StmtKind::Local(<span class="keyword">ref</span> local) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> hir_id = <span class="keyword">self</span>.lower_node_id(s.id);</span><br><span class="line">                    <span class="keyword">match</span> &amp;local.kind &#123;</span><br><span class="line">                        LocalKind::InitElse(init, els) =&gt; &#123;</span><br><span class="line">                            <span class="keyword">let</span> e = <span class="keyword">self</span>.lower_let_else(hir_id, local, init, els, tail);</span><br><span class="line">                            expr = <span class="literal">Some</span>(e);</span><br><span class="line">														<span class="comment">// remaining statements are in let-else expression</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>注意这里的break</p>
<p>来看一下InitElse</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">LocalKind</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">/// Local declaration with an initializer and an `else` clause.</span></span><br><span class="line">	<span class="comment">/// Example: `let Some(x) = y else &#123; return &#125;;`</span></span><br><span class="line">	InitElse(P&lt;Expr&gt;, P&lt;Block&gt;),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><p>函数签名</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_let_else</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        stmt_hir_id: hir::HirId,</span><br><span class="line">        local: &amp;Local,</span><br><span class="line">        init: &amp;Expr,</span><br><span class="line">        els: &amp;Block,</span><br><span class="line">        tail: &amp;[Stmt],</span><br><span class="line">    ) -&gt; &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br></pre></td></tr></table></figure>

<p>一开始看到函数签名中的tail产生了一些疑惑，不知道用途是什么。一开始想到的是会往里添加东西，但是一看类型是immutable的（传进来的是一个array的slice），后面看到调用处的break才明白过来，具体用途后面会讲到</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_let_else</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        stmt_hir_id: hir::HirId,</span><br><span class="line">        local: &amp;Local,</span><br><span class="line">        init: &amp;Expr,</span><br><span class="line">        els: &amp;Block,</span><br><span class="line">        tail: &amp;[Stmt],</span><br><span class="line">    ) -&gt; &amp;<span class="symbol">&#x27;hir</span> hir::Expr&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> ty = local</span><br><span class="line">	      .ty</span><br><span class="line">	      .as_ref()</span><br><span class="line">	      .map(|t| <span class="keyword">self</span>.lower_ty(t, ImplTraitContext::Disallowed(ImplTraitPosition::Variable)));</span><br><span class="line">  <span class="keyword">let</span> span = <span class="keyword">self</span>.lower_span(local.span);</span><br><span class="line">  <span class="keyword">let</span> span = <span class="keyword">self</span>.mark_span_with_reason(DesugaringKind::LetElse, span, <span class="literal">None</span>);</span><br><span class="line">  <span class="keyword">let</span> init = <span class="keyword">self</span>.lower_expr(init);</span><br><span class="line">  <span class="keyword">let</span> local_hir_id = <span class="keyword">self</span>.lower_node_id(local.id);</span><br><span class="line">  <span class="keyword">self</span>.lower_attrs(local_hir_id, &amp;local.attrs);</span><br><span class="line">  <span class="keyword">let</span> let_expr = &#123;</span><br><span class="line">      <span class="keyword">let</span> lex = <span class="keyword">self</span>.arena.alloc(hir::Let &#123;</span><br><span class="line">          hir_id: local_hir_id,</span><br><span class="line">          pat: <span class="keyword">self</span>.lower_pat(&amp;local.pat),</span><br><span class="line">          ty,</span><br><span class="line">          init,</span><br><span class="line">          span,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr(span, hir::ExprKind::Let(lex), AttrVec::new()))</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">let</span> then_expr = &#123;</span><br><span class="line">      <span class="keyword">let</span> (stmts, expr) = <span class="keyword">self</span>.lower_stmts(tail);</span><br><span class="line">      <span class="keyword">let</span> block = <span class="keyword">self</span>.block_all(span, stmts, expr);</span><br><span class="line">      <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_block(block, AttrVec::new()))</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">let</span> else_expr = &#123;</span><br><span class="line">      <span class="keyword">let</span> block = <span class="keyword">self</span>.lower_block(els, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_block(block, AttrVec::new()))</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">self</span>.alias_attrs(let_expr.hir_id, local_hir_id);</span><br><span class="line">  <span class="keyword">self</span>.alias_attrs(else_expr.hir_id, local_hir_id);</span><br><span class="line">  <span class="keyword">let</span> if_expr = <span class="keyword">self</span>.arena.alloc(hir::Expr &#123;</span><br><span class="line">      hir_id: stmt_hir_id,</span><br><span class="line">      span,</span><br><span class="line">      kind: hir::ExprKind::If(let_expr, then_expr, <span class="literal">Some</span>(else_expr)),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> !<span class="keyword">self</span>.sess.features_untracked().let_else &#123;</span><br><span class="line">      feature_err(</span><br><span class="line">          &amp;<span class="keyword">self</span>.sess.parse_sess,</span><br><span class="line">          sym::let_else,</span><br><span class="line">          local.span,</span><br><span class="line">          <span class="string">&quot;`let...else` statements are unstable&quot;</span>,</span><br><span class="line">      )</span><br><span class="line">      .emit();</span><br><span class="line">  &#125;</span><br><span class="line">  if_expr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们从返回值向上看，可以看到if_expr的参数是let_expr, then_expr, else_expr</p>
<ol>
<li>let_expr的部分转成了HIR的let</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> let_expr = &#123;</span><br><span class="line">    <span class="keyword">let</span> lex = <span class="keyword">self</span>.arena.alloc(hir::Let &#123;</span><br><span class="line">        hir_id: local_hir_id,</span><br><span class="line">        pat: <span class="keyword">self</span>.lower_pat(&amp;local.pat),</span><br><span class="line">        ty,</span><br><span class="line">        init,</span><br><span class="line">        span,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr(span, hir::ExprKind::Let(lex), AttrVec::new()))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们来看一下定义和注释</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents a `let &lt;pat&gt;[: &lt;ty&gt;] = &lt;expr&gt;` expression (not a Local), occurring in an `if-let` or</span></span><br><span class="line"><span class="comment">/// `let-else`, evaluating to a boolean. Typically the pattern is refutable.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In an if-let, imagine it as `if (let &lt;pat&gt; = &lt;expr&gt;) &#123; ... &#125;`; in a let-else, it is part of the</span></span><br><span class="line"><span class="comment">/// desugaring to if-let. Only let-else supports the type annotation at present.</span></span><br><span class="line"><span class="meta">#[derive(Debug, HashStable_Generic)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Let</span></span>&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> hir_id: HirId,</span><br><span class="line">    <span class="keyword">pub</span> span: Span,</span><br><span class="line">    <span class="keyword">pub</span> pat: &amp;<span class="symbol">&#x27;hir</span> Pat&lt;<span class="symbol">&#x27;hir</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> ty: <span class="built_in">Option</span>&lt;&amp;<span class="symbol">&#x27;hir</span> Ty&lt;<span class="symbol">&#x27;hir</span>&gt;&gt;,</span><br><span class="line">    <span class="keyword">pub</span> init: &amp;<span class="symbol">&#x27;hir</span> Expr&lt;<span class="symbol">&#x27;hir</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExprKind</span></span>&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">/// A `let $pat = $expr` expression.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// These are not `Local` and only occur as expressions.</span></span><br><span class="line">  <span class="comment">/// The `let Some(x) = foo()` in `if let Some(x) = foo()` is an example of `Let(..)`.</span></span><br><span class="line">  Let(&amp;<span class="symbol">&#x27;hir</span> Let&lt;<span class="symbol">&#x27;hir</span>&gt;),</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>then_expr</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> then_expr = &#123;</span><br><span class="line">    <span class="keyword">let</span> (stmts, expr) = <span class="keyword">self</span>.lower_stmts(tail);</span><br><span class="line">    <span class="keyword">let</span> block = <span class="keyword">self</span>.block_all(span, stmts, expr);</span><br><span class="line">    <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_block(block, AttrVec::new()))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里解答了我对传进来的tail的疑惑。这里的意思是then的话那么会继续lower tail的部分，将这部分插入到then的block中</p>
<ol>
<li>else_expr</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> else_expr = &#123;</span><br><span class="line">    <span class="keyword">let</span> block = <span class="keyword">self</span>.lower_block(els, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_block(block, AttrVec::new()))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里将传进来的els（InitElse的else block）lower到了一个block</p>
<h3 id="实际做了什么转换"><a href="#实际做了什么转换" class="headerlink" title="实际做了什么转换"></a>实际做了什么转换</h3><p>单个看起来可能不够直观，将三个部分组合起来的话这个逻辑就是</p>
<p>cond中创建了一个expr bind</p>
<p>true：将后面的stmts lower到一个新的block中（因此外面需要break）</p>
<p>false：将els的部分lower到block</p>
<h3 id="false为什么不lower-tail"><a href="#false为什么不lower-tail" class="headerlink" title="false为什么不lower tail"></a>false为什么不lower tail</h3><p>像我一样不了解这里语法的情况会觉得false的行为很奇怪，false就不走tail了吗</p>
<p>于是我就写了这样的一个用例</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(let_else)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> y:<span class="built_in">Option</span>&lt;<span class="built_in">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="literal">Some</span>(x) = y <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;fail&quot;</span>) &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接报了编译错误，else中的内容是要强制从当前函数返回才行</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">error[E0308]: `<span class="keyword">else</span>` clause of `<span class="keyword">let</span>...<span class="keyword">else</span>` does not diverge</span><br><span class="line"> --&gt; src/main.rs:<span class="number">4</span>:<span class="number">26</span></span><br><span class="line">  |</span><br><span class="line"><span class="number">4</span> |       <span class="keyword">let</span> <span class="literal">Some</span>(x) = y <span class="keyword">else</span> &#123; </span><br><span class="line">  |  __________________________^</span><br><span class="line"><span class="number">5</span> | |         <span class="built_in">println!</span>(<span class="string">&quot;fail&quot;</span>) &#125;;</span><br><span class="line">  | |__________________________^ expected `!`, found `()`</span><br><span class="line">  |</span><br><span class="line">  = note: expected <span class="class"><span class="keyword">type</span> `!`</span></span><br><span class="line"><span class="class">             <span class="title">found</span></span> <span class="class"><span class="keyword">type</span> `()`</span></span><br><span class="line"><span class="class">  = <span class="title">help</span></span>: <span class="keyword">try</span> adding a diverging expression, such <span class="keyword">as</span> `<span class="keyword">return</span>` or `<span class="built_in">panic!</span>(..)`</span><br><span class="line">  = help: ...or <span class="keyword">use</span> `<span class="keyword">match</span>` instead of `<span class="keyword">let</span>...<span class="keyword">else</span>`</span><br><span class="line"></span><br><span class="line">For more information about this error, <span class="keyword">try</span> `rustc --explain E0308`.</span><br><span class="line">error: could not compile `playground` due to previous error</span><br></pre></td></tr></table></figure>

<h2 id="WhileLoop"><a href="#WhileLoop" class="headerlink" title="WhileLoop"></a>WhileLoop</h2><p>在lower_expr_mut中被调用，在外部创建span信息然后在lower_expr_while_in_loop_scope中实际进行lower</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ExprKind::While(<span class="keyword">ref</span> cond, <span class="keyword">ref</span> body, opt_label) =&gt; &#123;</span><br><span class="line">      <span class="keyword">self</span>.with_loop_scope(e.id, |this| &#123;</span><br><span class="line">          <span class="keyword">let</span> span =</span><br><span class="line">              this.mark_span_with_reason(DesugaringKind::WhileLoop, e.span, <span class="literal">None</span>);</span><br><span class="line">          this.lower_expr_while_in_loop_scope(span, cond, body, opt_label)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="做了什么-2"><a href="#做了什么-2" class="headerlink" title="做了什么"></a>做了什么</h3><p>注释也非常易懂，将一个while转换为一个loop加一个，cond作为一个if，cond为false则break</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We desugar: `&#x27;label: while $cond $body` into:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ```</span></span><br><span class="line"><span class="comment">// &#x27;label: loop &#123;</span></span><br><span class="line"><span class="comment">//   if &#123; let _t = $cond; _t &#125; &#123;</span></span><br><span class="line"><span class="comment">//     $body</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">//   else &#123;</span></span><br><span class="line"><span class="comment">//     break;</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// ```</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Wrap in a construct equivalent to `&#123; let _t = $cond; _t &#125;`</span></span><br><span class="line"><span class="comment">// to preserve drop semantics since `while $cond &#123; ... &#125;` does not</span></span><br><span class="line"><span class="comment">// let temporaries live outside of `cond`.</span></span><br></pre></td></tr></table></figure>

<h3 id="实现-4"><a href="#实现-4" class="headerlink" title="实现"></a>实现</h3><p>实际的实现代码也是非常直接，没什么可讲的</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lower_expr_while_in_loop_scope</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    span: Span,</span><br><span class="line">    cond: &amp;Expr,</span><br><span class="line">    body: &amp;Block,</span><br><span class="line">    opt_label: <span class="built_in">Option</span>&lt;Label&gt;,</span><br><span class="line">) -&gt; hir::ExprKind&lt;<span class="symbol">&#x27;hir</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> lowered_cond = <span class="keyword">self</span>.with_loop_condition_scope(|t| t.lower_expr(cond));</span><br><span class="line">    <span class="keyword">let</span> new_cond = <span class="keyword">self</span>.manage_let_cond(lowered_cond);</span><br><span class="line">    <span class="keyword">let</span> then = <span class="keyword">self</span>.lower_block_expr(body);</span><br><span class="line">    <span class="keyword">let</span> expr_break = <span class="keyword">self</span>.expr_break(span, ThinVec::new());</span><br><span class="line">    <span class="keyword">let</span> stmt_break = <span class="keyword">self</span>.stmt_expr(span, expr_break);</span><br><span class="line">    <span class="keyword">let</span> else_blk = <span class="keyword">self</span>.block_all(span, arena_vec![<span class="keyword">self</span>; stmt_break], <span class="literal">None</span>);</span><br><span class="line">    <span class="keyword">let</span> else_expr = <span class="keyword">self</span>.arena.alloc(<span class="keyword">self</span>.expr_block(else_blk, ThinVec::new()));</span><br><span class="line">    <span class="keyword">let</span> if_kind = hir::ExprKind::If(new_cond, <span class="keyword">self</span>.arena.alloc(then), <span class="literal">Some</span>(else_expr));</span><br><span class="line">    <span class="keyword">let</span> if_expr = <span class="keyword">self</span>.expr(span, if_kind, ThinVec::new());</span><br><span class="line">    <span class="keyword">let</span> block = <span class="keyword">self</span>.block_expr(<span class="keyword">self</span>.arena.alloc(if_expr));</span><br><span class="line">    <span class="keyword">let</span> span = <span class="keyword">self</span>.lower_span(span.with_hi(cond.span.hi()));</span><br><span class="line">    <span class="keyword">let</span> opt_label = <span class="keyword">self</span>.lower_label(opt_label);</span><br><span class="line">    hir::ExprKind::Loop(block, opt_label, hir::LoopSource::While, span)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>本来以为desugar的东西比较少就想都写完，但是越写发现越多，这还忽略了很多细节上的东西，导致了文章比较长</p>
<p>在读代码的时候一开始我是没看到DesugaringKind这个类型的，想着既然要lower，那么首先将ast和hir的定义进行比较。由于内容比较多，只选了熟悉的Expr和Stmt进行对比。查看实际有哪些成员发生了变化，之后再去找到实现的位置。查看实现的过程中偶然看到DesugaringKind，之后看的过程就顺畅了许多</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>本文标题：Rc-lang开发周记15 Rust源码学习之desugar</li>
        <li>本文作者：Homura</li>
        <li>创建时间：2022-04-17 14:23:11</li>
        <li>
            本文链接：https://homura.live/2022/04/17/rc-lang-dev/rc-lang-dev-15/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/04/26/rc-lang-dev/rc-lang-dev-16/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Rc-lang开发周记16 Rust源码学习之初识类型</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/04/10/rc-lang-dev/rc-lang-dev-14/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Rc-lang开发周记14 重构与AST Visitor</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>&nbsp;-&nbsp;
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Homura</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.2</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#desugar"><span class="nav-number">1.</span> <span class="nav-text">desugar</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.</span> <span class="nav-text">是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81"><span class="nav-number">1.2.</span> <span class="nav-text">为什么需要</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rust%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">Rust的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E4%BB%A3%E7%A0%81%E4%B9%8B%E5%89%8D%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84"><span class="nav-number">2.1.</span> <span class="nav-text">读代码之前需要了解的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DesugaringKind"><span class="nav-number">2.2.</span> <span class="nav-text">DesugaringKind</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CondTemporary"><span class="nav-number">2.3.</span> <span class="nav-text">CondTemporary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E6%8D%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.3.1.</span> <span class="nav-text">转换条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.2.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E8%B4%A8%E8%A1%8C%E4%B8%BA"><span class="nav-number">2.3.3.</span> <span class="nav-text">本质行为</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QuestionMark"><span class="nav-number">2.4.</span> <span class="nav-text">QuestionMark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="nav-number">2.4.2.</span> <span class="nav-text">做了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TryBlock"><span class="nav-number">2.5.</span> <span class="nav-text">TryBlock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">做了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="nav-number">2.5.2.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpaqueTy"><span class="nav-number">2.6.</span> <span class="nav-text">OpaqueTy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpaqueTy%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">2.6.1.</span> <span class="nav-text">OpaqueTy是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lower%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="nav-number">2.6.2.</span> <span class="nav-text">lower做了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lower%E6%93%8D%E4%BD%9C"><span class="nav-number">2.6.3.</span> <span class="nav-text">lower操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ImpltraitContext"><span class="nav-number">2.6.4.</span> <span class="nav-text">ImpltraitContext</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ForLoop"><span class="nav-number">2.7.</span> <span class="nav-text">ForLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LetElse"><span class="nav-number">2.8.</span> <span class="nav-text">LetElse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%BC%9A%E8%BD%AC%E6%8D%A2"><span class="nav-number">2.8.1.</span> <span class="nav-text">什么情况会转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="nav-number">2.8.2.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%E8%BD%AC%E6%8D%A2"><span class="nav-number">2.8.3.</span> <span class="nav-text">实际做了什么转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#false%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8Dlower-tail"><span class="nav-number">2.8.4.</span> <span class="nav-text">false为什么不lower tail</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WhileLoop"><span class="nav-number">2.9.</span> <span class="nav-text">WhileLoop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88-2"><span class="nav-number">2.9.1.</span> <span class="nav-text">做了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-4"><span class="nav-number">2.9.2.</span> <span class="nav-text">实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%80%E5%90%8E"><span class="nav-number">3.</span> <span class="nav-text">最后</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
